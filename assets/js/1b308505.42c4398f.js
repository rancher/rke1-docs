"use strict";(self.webpackChunkrke_docs=self.webpackChunkrke_docs||[]).push([[7397],{3889:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>p,frontMatter:()=>c,metadata:()=>i,toc:()=>h});var r=t(5893),n=t(1151),o=t(4866),a=t(5162);const c={title:"Restoring from Backup"},l=void 0,i={id:"etcd-snapshots/restoring-from-backup/restoring-from-backup",title:"Restoring from Backup",description:"The details of restoring your cluster from backup are different depending on your version of RKE.",source:"@site/docs/etcd-snapshots/restoring-from-backup/restoring-from-backup.md",sourceDirName:"etcd-snapshots/restoring-from-backup",slug:"/etcd-snapshots/restoring-from-backup/",permalink:"/etcd-snapshots/restoring-from-backup/",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke1-docs/edit/main/docs/etcd-snapshots/restoring-from-backup/restoring-from-backup.md",tags:[],version:"current",lastUpdatedAt:1704844723,formattedLastUpdatedAt:"Jan 9, 2024",frontMatter:{title:"Restoring from Backup"},sidebar:"mySidebar",previous:{title:"Recurring Snapshots",permalink:"/etcd-snapshots/recurring-snapshots/"},next:{title:"Example Scenarios",permalink:"/etcd-snapshots/example-scenarios/"}},d={},h=[{value:"Example of Restoring from a Local Snapshot",id:"example-of-restoring-from-a-local-snapshot",level:3},{value:"Example of Restoring from a Snapshot in S3",id:"example-of-restoring-from-a-snapshot-in-s3",level:3},{value:"Options for <code>rke etcd snapshot-restore</code>",id:"options-for-rke-etcd-snapshot-restore",level:3},{value:"Example of Restoring from a Local Snapshot",id:"example-of-restoring-from-a-local-snapshot-1",level:3},{value:"Options for <code>rke etcd snapshot-restore</code>",id:"options-for-rke-etcd-snapshot-restore-1",level:3}];function u(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,n.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.p,{children:"The details of restoring your cluster from backup are different depending on your version of RKE."}),"\n",(0,r.jsxs)(o.Z,{children:[(0,r.jsxs)(a.Z,{value:"RKE v0.2.0+",children:[(0,r.jsxs)(s.p,{children:["If there is a disaster with your Kubernetes cluster, you can use ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})," to recover your etcd. This command reverts etcd to a specific snapshot and should be run on an etcd node of the the specific cluster that has suffered the disaster."]}),(0,r.jsx)(s.p,{children:"The following actions will be performed when you run the command:"}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Syncs the snapshot or downloads the snapshot from S3, if necessary."}),"\n",(0,r.jsx)(s.li,{children:"Checks snapshot checksum across etcd nodes to make sure they are identical."}),"\n",(0,r.jsxs)(s.li,{children:["Deletes your current cluster and cleans old data by running ",(0,r.jsx)(s.code,{children:"rke remove"}),". This removes the entire Kubernetes cluster, not just the etcd cluster."]}),"\n",(0,r.jsx)(s.li,{children:"Rebuilds the etcd cluster from the chosen snapshot."}),"\n",(0,r.jsxs)(s.li,{children:["Creates a new cluster by running ",(0,r.jsx)(s.code,{children:"rke up"}),"."]}),"\n",(0,r.jsx)(s.li,{children:"Restarts cluster system pods."}),"\n"]}),(0,r.jsx)(s.admonition,{type:"danger",children:(0,r.jsxs)(s.p,{children:["You should back up any important data in your cluster before running ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})," because the command deletes your current Kubernetes cluster and replaces it with a new one."]})}),(0,r.jsxs)(s.p,{children:["The snapshot used to restore your etcd cluster can either be stored locally in ",(0,r.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"})," or from a S3 compatible backend."]}),(0,r.jsx)(s.p,{children:(0,r.jsx)(s.em,{children:"Available as of v1.1.4"})}),(0,r.jsxs)(s.p,{children:["If the snapshot contains the cluster state file, it will automatically be extracted and used for the restore. If you want to force the use of the local state file, you can add ",(0,r.jsx)(s.code,{children:"--use-local-state"})," to the command. If the snapshot was created using an RKE version before v1.1.4, or if the snapshot does not contain a state file, make sure the cluster state file (by default available as ",(0,r.jsx)(s.code,{children:"cluster.rkestate"}),") is present before executing the command."]}),(0,r.jsx)(s.h3,{id:"example-of-restoring-from-a-local-snapshot",children:"Example of Restoring from a Local Snapshot"}),(0,r.jsx)(s.p,{children:"To restore etcd from a local snapshot, run:"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"$ rke etcd snapshot-restore --config cluster.yml --name mysnapshot\n"})}),(0,r.jsxs)(s.p,{children:["The snapshot is assumed to be located in ",(0,r.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),"."]}),(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," The ",(0,r.jsx)(s.code,{children:"pki.bundle.tar.gz"})," file is not needed because RKE v0.2.0 changed how the ",(0,r.jsx)(s.a,{href:"/installation/#kubernetes-cluster-state",children:"Kubernetes cluster state is stored"}),"."]}),(0,r.jsx)(s.h3,{id:"example-of-restoring-from-a-snapshot-in-s3",children:"Example of Restoring from a Snapshot in S3"}),(0,r.jsx)(s.p,{children:"When restoring etcd from a snapshot located in S3, the command needs the S3 information in order to connect to the S3 backend and retrieve the snapshot."}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell",children:"$ rke etcd snapshot-restore \\\n--config cluster.yml \\\n--name snapshot-name \\\n--s3 \\\n--access-key S3_ACCESS_KEY \\\n--secret-key S3_SECRET_KEY \\\n--bucket-name s3-bucket-name \\\n--folder s3-folder-name \\ # Optional - Available as of v0.3.0\n--s3-endpoint s3.amazonaws.com\n"})}),(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," if you were restoring a cluster that had Rancher installed, the Rancher UI should start up after a few minutes; you don't need to re-run Helm."]}),(0,r.jsxs)(s.h3,{id:"options-for-rke-etcd-snapshot-restore",children:["Options for ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})]}),(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Option"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"S3 Specific"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--name"})," value"]}),(0,r.jsx)(s.td,{children:"Specify snapshot name"}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--config"})," value"]}),(0,r.jsxs)(s.td,{children:["Specify an alternate cluster YAML file (default: ",(0,r.jsx)(s.code,{children:"cluster.yml"}),") [$RKE_CONFIG]"]}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--use-local-state"})}),(0,r.jsxs)(s.td,{children:["Force the use of the local state file instead of looking for a state file in the snapshot ",(0,r.jsx)(s.em,{children:"Available as of v1.1.4"})]}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--s3"})}),(0,r.jsx)(s.td,{children:"Enabled backup to s3"}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--s3-endpoint"})," value"]}),(0,r.jsx)(s.td,{children:'Specify s3 endpoint url (default: "s3.amazonaws.com")'}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--access-key"})," value"]}),(0,r.jsx)(s.td,{children:"Specify s3 accessKey"}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--secret-key"})," value"]}),(0,r.jsx)(s.td,{children:"Specify s3 secretKey"}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--bucket-name"})," value"]}),(0,r.jsx)(s.td,{children:"Specify s3 bucket name"}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--folder"})," value"]}),(0,r.jsxs)(s.td,{children:["Specify folder inside  bucket where backup will be stored. This is optional.  This is optional. ",(0,r.jsx)(s.em,{children:"Available as of v0.3.0"})]}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--region"})," value"]}),(0,r.jsx)(s.td,{children:"Specify the s3 bucket location (optional)"}),(0,r.jsx)(s.td,{children:"*"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--ssh-agent-auth"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/config-options/#ssh-agent",children:"Use SSH Agent Auth defined by SSH_AUTH_SOCK"})}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--ignore-docker-version"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/config-options/#supported-docker-versions",children:"Disable Docker version check"})}),(0,r.jsx)(s.td,{})]})]})]})]}),(0,r.jsxs)(a.Z,{value:"RKE before v0.2.0",children:[(0,r.jsxs)(s.p,{children:["If there is a disaster with your Kubernetes cluster, you can use ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})," to recover your etcd. This command reverts etcd to a specific snapshot and should be run on an etcd node of the the specific cluster that has suffered the disaster."]}),(0,r.jsx)(s.p,{children:"The following actions will be performed when you run the command:"}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Removes the old etcd cluster"}),"\n",(0,r.jsx)(s.li,{children:"Rebuilds the etcd cluster using the local snapshot"}),"\n"]}),(0,r.jsx)(s.p,{children:"Before you run this command, you must:"}),(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Run ",(0,r.jsx)(s.code,{children:"rke remove"})," to remove your Kubernetes cluster and clean the nodes"]}),"\n",(0,r.jsxs)(s.li,{children:["Download your etcd snapshot from S3, if applicable. Place the etcd snapshot and the ",(0,r.jsx)(s.code,{children:"pki.bundle.tar.gz"})," file in ",(0,r.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),". Manually sync the snapshot across all ",(0,r.jsx)(s.code,{children:"etcd"})," nodes."]}),"\n"]}),(0,r.jsxs)(s.p,{children:["After the restore, you must rebuild your Kubernetes cluster with ",(0,r.jsx)(s.code,{children:"rke up"}),"."]}),(0,r.jsx)(s.admonition,{type:"danger",children:(0,r.jsxs)(s.p,{children:["You should back up any important data in your cluster before running ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})," because the command deletes your current etcd cluster and replaces it with a new one."]})}),(0,r.jsx)(s.h3,{id:"example-of-restoring-from-a-local-snapshot-1",children:"Example of Restoring from a Local Snapshot"}),(0,r.jsx)(s.p,{children:"To restore etcd from a local snapshot, run:"}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"$ rke etcd snapshot-restore --config cluster.yml --name mysnapshot\n"})}),(0,r.jsxs)(s.p,{children:["The snapshot is assumed to be located in ",(0,r.jsx)(s.code,{children:"/opt/rke/etcd-snapshots"}),"."]}),(0,r.jsxs)(s.p,{children:["The snapshot must be manually synched across all ",(0,r.jsx)(s.code,{children:"etcd"})," nodes."]}),(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"pki.bundle.tar.gz"})," file is also expected to be in the same location."]}),(0,r.jsxs)(s.h3,{id:"options-for-rke-etcd-snapshot-restore-1",children:["Options for ",(0,r.jsx)(s.code,{children:"rke etcd snapshot-restore"})]}),(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Option"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--name"})," value"]}),(0,r.jsx)(s.td,{children:"Specify snapshot name"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"--config"})," value"]}),(0,r.jsxs)(s.td,{children:["Specify an alternate cluster YAML file (default: ",(0,r.jsx)(s.code,{children:"cluster.yml"}),") [$RKE_CONFIG]"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--ssh-agent-auth"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/config-options/#ssh-agent",children:"Use SSH Agent Auth defined by SSH_AUTH_SOCK"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--ignore-docker-version"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/config-options/#supported-docker-versions",children:"Disable Docker version check"})})]})]})]})]})]})]})}function p(e={}){const{wrapper:s}={...(0,n.a)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},5162:(e,s,t)=>{t.d(s,{Z:()=>a});t(7294);var r=t(4334);const n={tabItem:"tabItem_Ymn6"};var o=t(5893);function a(e){let{children:s,hidden:t,className:a}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,r.Z)(n.tabItem,a),hidden:t,children:s})}},4866:(e,s,t)=>{t.d(s,{Z:()=>k});var r=t(7294),n=t(4334),o=t(2466),a=t(6550),c=t(469),l=t(1980),i=t(7392),d=t(12);function h(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:s}=e;return!!s&&"object"==typeof s&&"value"in s}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function u(e){const{values:s,children:t}=e;return(0,r.useMemo)((()=>{const e=s??function(e){return h(e).map((e=>{let{props:{value:s,label:t,attributes:r,default:n}}=e;return{value:s,label:t,attributes:r,default:n}}))}(t);return function(e){const s=(0,i.l)(e,((e,s)=>e.value===s.value));if(s.length>0)throw new Error(`Docusaurus error: Duplicate values "${s.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[s,t])}function p(e){let{value:s,tabValues:t}=e;return t.some((e=>e.value===s))}function f(e){let{queryString:s=!1,groupId:t}=e;const n=(0,a.k6)(),o=function(e){let{queryString:s=!1,groupId:t}=e;if("string"==typeof s)return s;if(!1===s)return null;if(!0===s&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:s,groupId:t});return[(0,l._X)(o),(0,r.useCallback)((e=>{if(!o)return;const s=new URLSearchParams(n.location.search);s.set(o,e),n.replace({...n.location,search:s.toString()})}),[o,n])]}function x(e){const{defaultValue:s,queryString:t=!1,groupId:n}=e,o=u(e),[a,l]=(0,r.useState)((()=>function(e){let{defaultValue:s,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(s){if(!p({value:s,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${s}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return s}const r=t.find((e=>e.default))??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:s,tabValues:o}))),[i,h]=f({queryString:t,groupId:n}),[x,m]=function(e){let{groupId:s}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(s),[n,o]=(0,d.Nk)(t);return[n,(0,r.useCallback)((e=>{t&&o.set(e)}),[t,o])]}({groupId:n}),j=(()=>{const e=i??x;return p({value:e,tabValues:o})?e:null})();(0,c.Z)((()=>{j&&l(j)}),[j]);return{selectedValue:a,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);l(e),h(e),m(e)}),[h,m,o]),tabValues:o}}var m=t(2389);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=t(5893);function g(e){let{className:s,block:t,selectedValue:r,selectValue:a,tabValues:c}=e;const l=[],{blockElementScrollPositionUntilNextRender:i}=(0,o.o5)(),d=e=>{const s=e.currentTarget,t=l.indexOf(s),n=c[t].value;n!==r&&(i(s),a(n))},h=e=>{let s=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;s=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;s=l[t]??l[l.length-1];break}}s?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,n.Z)("tabs",{"tabs--block":t},s),children:c.map((e=>{let{value:s,label:t,attributes:o}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:r===s?0:-1,"aria-selected":r===s,ref:e=>l.push(e),onKeyDown:h,onClick:d,...o,className:(0,n.Z)("tabs__item",j.tabItem,o?.className,{"tabs__item--active":r===s}),children:t??s},s)}))})}function v(e){let{lazy:s,children:t,selectedValue:n}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(s){const e=o.find((e=>e.props.value===n));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:o.map(((e,s)=>(0,r.cloneElement)(e,{key:s,hidden:e.props.value!==n})))})}function y(e){const s=x(e);return(0,b.jsxs)("div",{className:(0,n.Z)("tabs-container",j.tabList),children:[(0,b.jsx)(g,{...e,...s}),(0,b.jsx)(v,{...e,...s})]})}function k(e){const s=(0,m.Z)();return(0,b.jsx)(y,{...e,children:h(e.children)},String(s))}},1151:(e,s,t)=>{t.d(s,{Z:()=>c,a:()=>a});var r=t(7294);const n={},o=r.createContext(n);function a(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);
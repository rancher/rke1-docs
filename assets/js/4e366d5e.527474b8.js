"use strict";(self.webpackChunkrke_docs=self.webpackChunkrke_docs||[]).push([[3595],{2798:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>d,toc:()=>c});var s=r(5893),t=r(1151),i=r(4866),a=r(5162);const o={title:"Upgrades"},l=void 0,d={id:"upgrades/upgrades",title:"Upgrades",description:"After RKE has deployed Kubernetes, you can upgrade the versions of the components in your Kubernetes cluster, the definition of the Kubernetes services or the add-ons.",source:"@site/docs/upgrades/upgrades.md",sourceDirName:"upgrades",slug:"/upgrades/",permalink:"/upgrades/",draft:!1,unlisted:!1,editUrl:"https://github.com/rancher/rke1-docs/edit/main/docs/upgrades/upgrades.md",tags:[],version:"current",lastUpdatedAt:1704844723,formattedLastUpdatedAt:"Jan 9, 2024",frontMatter:{title:"Upgrades"},sidebar:"mySidebar",previous:{title:"Custom Certificates",permalink:"/installation/certs/"},next:{title:"How Upgrades Work",permalink:"/upgrades/how-upgrades-work/"}},u={},c=[{value:"How Upgrades Work",id:"how-upgrades-work",level:3},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Upgrading Kubernetes",id:"upgrading-kubernetes",level:3},{value:"Configuring the Upgrade Strategy",id:"configuring-the-upgrade-strategy",level:3},{value:"Maintaining Availability for Applications During Upgrades",id:"maintaining-availability-for-applications-during-upgrades",level:3},{value:"Listing Supported Kubernetes Versions",id:"listing-supported-kubernetes-versions",level:3},{value:"Kubernetes Version Precedence",id:"kubernetes-version-precedence",level:3},{value:"Using an Unsupported Kubernetes Version",id:"using-an-unsupported-kubernetes-version",level:3},{value:"Mapping the Kubernetes Version to Services",id:"mapping-the-kubernetes-version-to-services",level:3},{value:"Service Upgrades",id:"service-upgrades",level:3},{value:"Upgrading Nodes Manually",id:"upgrading-nodes-manually",level:3},{value:"Rolling Back the Kubernetes Version",id:"rolling-back-the-kubernetes-version",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["After RKE has deployed Kubernetes, you can upgrade the versions of the components in your Kubernetes cluster, the ",(0,s.jsx)(n.a,{href:"/config-options/services/",children:"definition of the Kubernetes services"})," or the ",(0,s.jsx)(n.a,{href:"/config-options/add-ons/",children:"add-ons"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The default Kubernetes version for each RKE version can be found in the release notes accompanying ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/rke/releases/",children:"the RKE download"}),". These can also be checked with the ",(0,s.jsx)(n.a,{href:"#listing-supported-kubernetes-versions",children:"rke CLI"})]}),"\n",(0,s.jsxs)(n.p,{children:["You can also select a newer version of Kubernetes to install for your cluster but please avoid skipping minor versions, as this can increase the chances of an issue due to accumulated changes, as per the ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/releases/version-skew-policy/",children:"upstream Kubernetes documentation"})]}),"\n",(0,s.jsxs)(n.p,{children:["In case the Kubernetes version is defined in the ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," directive and under the ",(0,s.jsx)(n.code,{children:"system-images"})," directive, the ",(0,s.jsx)(n.code,{children:"system-images"})," configuration will take precedence over the ",(0,s.jsx)(n.code,{children:"kubernetes_version"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"how-upgrades-work",children:"How Upgrades Work"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"/upgrades/how-upgrades-work/",children:"this section,"})," you'll learn what happens when you edit or upgrade your RKE Kubernetes cluster."]}),"\n",(0,s.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure that any ",(0,s.jsx)(n.code,{children:"system_images"})," configuration is absent from the ",(0,s.jsx)(n.code,{children:"cluster.yml"}),". The Kubernetes version should only be listed under the ",(0,s.jsx)(n.code,{children:"system_images"})," directive if an ",(0,s.jsx)(n.a,{href:"#using-an-unsupported-kubernetes-version",children:"unsupported version"})," is being used. Refer to ",(0,s.jsx)(n.a,{href:"#kubernetes-version-precedence",children:"Kubernetes version precedence"})," for more information."]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure that the correct files to manage ",(0,s.jsx)(n.a,{href:"/installation/#kubernetes-cluster-state",children:"Kubernetes cluster state"})," are present in the working directory. Refer to the tabs below for the required files, which differ based on the RKE version."]}),"\n"]}),"\n",(0,s.jsxs)(i.Z,{children:[(0,s.jsxs)(a.Z,{value:"RKE v0.2.0+",children:[(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"cluster.rkestate"})," file contains the current state of the cluster including the RKE configuration and the certificates."]}),(0,s.jsxs)(n.p,{children:["This file is created in the same directory that has the cluster configuration file ",(0,s.jsx)(n.code,{children:"cluster.yml"}),"."]}),(0,s.jsxs)(n.p,{children:["It is required to keep the ",(0,s.jsx)(n.code,{children:"cluster.rkestate"})," file to perform any operation on the cluster through RKE, or when upgrading a cluster last managed via RKE v0.2.0 or later."]})]}),(0,s.jsxs)(a.Z,{value:"RKE before v0.2.0",children:[(0,s.jsxs)(n.p,{children:["Ensure that the ",(0,s.jsx)(n.code,{children:"kube_config_cluster.yml"})," file is present in the working directory."]}),(0,s.jsxs)(n.p,{children:["RKE saves the Kubernetes cluster state as a secret. When updating the state, RKE pulls the secret, updates or changes the state, and saves a new secret. The ",(0,s.jsx)(n.code,{children:"kube_config_cluster.yml"})," file is required for upgrading a cluster last managed via RKE v0.1.x."]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"upgrading-kubernetes",children:"Upgrading Kubernetes"}),"\n",(0,s.jsxs)(n.p,{children:["To upgrade the Kubernetes version of an RKE-provisioned cluster, set the ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," string in the ",(0,s.jsx)(n.code,{children:"cluster.yml"})," to the desired version from the ",(0,s.jsx)(n.a,{href:"#listing-supported-kubernetes-versions",children:"list of supported Kubernetes versions"})," for the specific version of RKE:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'kubernetes_version: "v1.15.5-rancher1-1"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Then invoke ",(0,s.jsx)(n.code,{children:"rke up"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"$ rke up --config cluster.yml\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configuring-the-upgrade-strategy",children:"Configuring the Upgrade Strategy"}),"\n",(0,s.jsxs)(n.p,{children:["As of v0.1.8, upgrades to add-ons are supported. ",(0,s.jsx)(n.a,{href:"/config-options/add-ons/",children:"Add-ons"})," can also be upgraded by changing any of the add-ons and running ",(0,s.jsx)(n.code,{children:"rke up"})," again with the updated configuration file."]}),"\n",(0,s.jsx)(n.p,{children:"As of v1.1.0, additional upgrade options became available to give you more granular control over the upgrade process. These options can be used to maintain availability of your applications during a cluster upgrade."}),"\n",(0,s.jsxs)(n.p,{children:["For details on upgrade configuration options, refer to ",(0,s.jsx)(n.a,{href:"/upgrades/configuring-strategy/",children:"Configuring the Upgrade Strategy."})]}),"\n",(0,s.jsx)(n.h3,{id:"maintaining-availability-for-applications-during-upgrades",children:"Maintaining Availability for Applications During Upgrades"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"/upgrades/maintaining-availability/",children:"this section,"})," you'll learn the requirements to prevent downtime for your applications when you upgrade the cluster using ",(0,s.jsx)(n.code,{children:"rke up"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"listing-supported-kubernetes-versions",children:"Listing Supported Kubernetes Versions"}),"\n",(0,s.jsxs)(n.p,{children:["Please refer to the ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/rke/releases",children:"release notes"})," of the RKE version that you are running, to find the list of supported Kubernetes versions as well as the default Kubernetes version. Note: RKE v1.x should be used."]}),"\n",(0,s.jsx)(n.p,{children:"You can also list the supported versions and system images of specific version of RKE release with a quick command."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"$ rke config --list-version --all\nv1.15.3-rancher2-1\nv1.13.10-rancher1-2\nv1.14.6-rancher2-1\nv1.16.0-beta.1-rancher1-1\n"})}),"\n",(0,s.jsx)(n.h3,{id:"kubernetes-version-precedence",children:"Kubernetes Version Precedence"}),"\n",(0,s.jsxs)(n.p,{children:["In case both ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," and ",(0,s.jsx)(n.code,{children:"system_images"})," are defined, the ",(0,s.jsx)(n.code,{children:"system_images"})," configuration will take precedence over ",(0,s.jsx)(n.code,{children:"kubernetes_version"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["In addition, if neither ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," nor ",(0,s.jsx)(n.code,{children:"system_images"})," are configured in the ",(0,s.jsx)(n.code,{children:"cluster.yml"}),", RKE will apply the default Kubernetes version for the specific version of RKE used to invoke ",(0,s.jsx)(n.code,{children:"rke up"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"using-an-unsupported-kubernetes-version",children:"Using an Unsupported Kubernetes Version"}),"\n",(0,s.jsxs)(n.p,{children:["As of v0.2.0, if a version is defined in ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," and is not found in the specific list of supported Kubernetes versions, then RKE will error out."]}),"\n",(0,s.jsxs)(n.p,{children:["Before v0.2.0, if a version is defined in ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," and is not found in the specific list of supported Kubernetes versions,  the default version from the supported list is used."]}),"\n",(0,s.jsxs)(n.p,{children:["If you want to use a different version from the supported list, please use the ",(0,s.jsx)(n.a,{href:"/config-options/system-images/",children:"system images"})," option."]}),"\n",(0,s.jsx)(n.h3,{id:"mapping-the-kubernetes-version-to-services",children:"Mapping the Kubernetes Version to Services"}),"\n",(0,s.jsxs)(n.p,{children:["In RKE, ",(0,s.jsx)(n.code,{children:"kubernetes_version"})," is used to map the version of Kubernetes to the default services, parameters, and options."]}),"\n",(0,s.jsxs)(n.p,{children:["For RKE v0.3.0+, the service defaults are located ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/kontainer-driver-metadata/blob/master/rke/k8s_service_options.go",children:"here"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For RKE before v0.3.0, the service defaults are located ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/types/blob/release/v2.2/apis/management.cattle.io/v3/k8s_defaults.go",children:"here"}),". Note: The version in the path of the service defaults file corresponds to a Rancher version. Therefore, for Rancher v2.1.x, ",(0,s.jsx)(n.a,{href:"https://github.com/rancher/types/blob/release/v2.1/apis/management.cattle.io/v3/k8s_defaults.go",children:"this file"})," should be used."]}),"\n",(0,s.jsx)(n.h3,{id:"service-upgrades",children:"Service Upgrades"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/config-options/services/",children:"Services"})," can be upgraded by changing any of the services arguments or ",(0,s.jsx)(n.code,{children:"extra_args"})," and running ",(0,s.jsx)(n.code,{children:"rke up"})," again with the updated configuration file."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The following arguments, ",(0,s.jsx)(n.code,{children:"service_cluster_ip_range"})," or ",(0,s.jsx)(n.code,{children:"cluster_cidr"}),", cannot be changed as any changes to these arguments will result in a broken cluster. Currently, network pods are not automatically upgraded."]})}),"\n",(0,s.jsx)(n.h3,{id:"upgrading-nodes-manually",children:"Upgrading Nodes Manually"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Available as of v1.1.0"})}),"\n",(0,s.jsx)(n.p,{children:"You can manually update each type of node separately. As a best practice, upgrade the etcd nodes first, followed by controlplane and then worker nodes."}),"\n",(0,s.jsx)(n.h3,{id:"rolling-back-the-kubernetes-version",children:"Rolling Back the Kubernetes Version"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Available as of v1.1.0"})}),"\n",(0,s.jsx)(n.p,{children:"A cluster can be restored back to a snapshot that uses a previous Kubernetes version."}),"\n",(0,s.jsx)(n.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Applies to v1.1.0+"})}),"\n",(0,s.jsxs)(n.p,{children:["If a node doesn't come up after an upgrade, the ",(0,s.jsx)(n.code,{children:"rke up"})," command errors out."]}),"\n",(0,s.jsx)(n.p,{children:"No upgrade will proceed if the number of unavailable nodes exceeds the configured maximum."}),"\n",(0,s.jsx)(n.p,{children:"If an upgrade stops, you may need to fix an unavailable node or remove it from the cluster before the upgrade can continue."}),"\n",(0,s.jsx)(n.p,{children:"A failed node could be in many different states:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Powered off"}),"\n",(0,s.jsx)(n.li,{children:"Unavailable"}),"\n",(0,s.jsx)(n.li,{children:"User drains a node while upgrade is in process, so there are no kubelets on the node"}),"\n",(0,s.jsx)(n.li,{children:"The upgrade itself failed"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Some expected failure scenarios include the following:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If the maximum unavailable number of nodes is reached during an upgrade, the RKE CLI will error out and exit the CLI with a failure code."}),"\n",(0,s.jsx)(n.li,{children:"If some nodes fail to upgrade, but the number of failed nodes doesn't reach the maximum unavailable number of nodes, the RKE CLI logs the nodes that were unable to upgrade and continues to upgrade the add-ons. After the add-ons are upgraded, RKE will error out and exit the CLI with a failure code regardless of add-on upgrade status."}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},5162:(e,n,r)=>{r.d(n,{Z:()=>a});r(7294);var s=r(4334);const t={tabItem:"tabItem_Ymn6"};var i=r(5893);function a(e){let{children:n,hidden:r,className:a}=e;return(0,i.jsx)("div",{role:"tabpanel",className:(0,s.Z)(t.tabItem,a),hidden:r,children:n})}},4866:(e,n,r)=>{r.d(n,{Z:()=>k});var s=r(7294),t=r(4334),i=r(2466),a=r(6550),o=r(469),l=r(1980),d=r(7392),u=r(12);function c(e){return s.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:r}=e;return(0,s.useMemo)((()=>{const e=n??function(e){return c(e).map((e=>{let{props:{value:n,label:r,attributes:s,default:t}}=e;return{value:n,label:r,attributes:s,default:t}}))}(r);return function(e){const n=(0,d.l)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,r])}function p(e){let{value:n,tabValues:r}=e;return r.some((e=>e.value===n))}function f(e){let{queryString:n=!1,groupId:r}=e;const t=(0,a.k6)(),i=function(e){let{queryString:n=!1,groupId:r}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:n,groupId:r});return[(0,l._X)(i),(0,s.useCallback)((e=>{if(!i)return;const n=new URLSearchParams(t.location.search);n.set(i,e),t.replace({...t.location,search:n.toString()})}),[i,t])]}function g(e){const{defaultValue:n,queryString:r=!1,groupId:t}=e,i=h(e),[a,l]=(0,s.useState)((()=>function(e){let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${r.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const s=r.find((e=>e.default))??r[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:i}))),[d,c]=f({queryString:r,groupId:t}),[g,v]=function(e){let{groupId:n}=e;const r=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,i]=(0,u.Nk)(r);return[t,(0,s.useCallback)((e=>{r&&i.set(e)}),[r,i])]}({groupId:t}),b=(()=>{const e=d??g;return p({value:e,tabValues:i})?e:null})();(0,o.Z)((()=>{b&&l(b)}),[b]);return{selectedValue:a,selectValue:(0,s.useCallback)((e=>{if(!p({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);l(e),c(e),v(e)}),[c,v,i]),tabValues:i}}var v=r(2389);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var m=r(5893);function x(e){let{className:n,block:r,selectedValue:s,selectValue:a,tabValues:o}=e;const l=[],{blockElementScrollPositionUntilNextRender:d}=(0,i.o5)(),u=e=>{const n=e.currentTarget,r=l.indexOf(n),t=o[r].value;t!==s&&(d(n),a(t))},c=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const r=l.indexOf(e.currentTarget)+1;n=l[r]??l[0];break}case"ArrowLeft":{const r=l.indexOf(e.currentTarget)-1;n=l[r]??l[l.length-1];break}}n?.focus()};return(0,m.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.Z)("tabs",{"tabs--block":r},n),children:o.map((e=>{let{value:n,label:r,attributes:i}=e;return(0,m.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>l.push(e),onKeyDown:c,onClick:u,...i,className:(0,t.Z)("tabs__item",b.tabItem,i?.className,{"tabs__item--active":s===n}),children:r??n},n)}))})}function j(e){let{lazy:n,children:r,selectedValue:t}=e;const i=(Array.isArray(r)?r:[r]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===t));return e?(0,s.cloneElement)(e,{className:"margin-top--md"}):null}return(0,m.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t})))})}function y(e){const n=g(e);return(0,m.jsxs)("div",{className:(0,t.Z)("tabs-container",b.tabList),children:[(0,m.jsx)(x,{...e,...n}),(0,m.jsx)(j,{...e,...n})]})}function k(e){const n=(0,v.Z)();return(0,m.jsx)(y,{...e,children:c(e.children)},String(n))}},1151:(e,n,r)=>{r.d(n,{Z:()=>o,a:()=>a});var s=r(7294);const t={},i=s.createContext(t);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);
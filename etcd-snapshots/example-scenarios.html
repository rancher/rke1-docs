<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-etcd-snapshots/example-scenarios/example-scenarios" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Example Scenarios | RKE1</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rke.docs.rancher.com/etcd-snapshots/example-scenarios"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Example Scenarios | RKE1"><meta data-rh="true" name="description" content="These example scenarios for backup and restore are different based on your version of RKE."><meta data-rh="true" property="og:description" content="These example scenarios for backup and restore are different based on your version of RKE."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rke.docs.rancher.com/etcd-snapshots/example-scenarios"><link data-rh="true" rel="alternate" href="https://rke.docs.rancher.com/etcd-snapshots/example-scenarios" hreflang="en"><link data-rh="true" rel="alternate" href="https://rke.docs.rancher.com/etcd-snapshots/example-scenarios" hreflang="x-default"><link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-57KS2MW",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><link rel="stylesheet" href="/assets/css/styles.d476b531.css">
<script src="/assets/js/runtime~main.84d973c4.js" defer="defer"></script>
<script src="/assets/js/main.dfa214e8.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57KS2MW" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-horizontal-rke.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-horizontal-rke.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Quick Links</a><ul class="dropdown__menu"><li><a href="https://github.com/rancher/rke" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/rancher/rke1-docs" target="_blank" rel="noopener noreferrer" class="dropdown__link">Docs GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher">Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental">Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://epinio.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__epinio">Epinio<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://fleet.rancher.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__fleet">Fleet<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://harvesterhci.io" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__harvester">Harvester<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://opensource.suse.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse">More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Overview of RKE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/os">Requirements</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/installation">RKE Kubernetes Installation</a><button aria-label="Expand sidebar category &#x27;RKE Kubernetes Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/upgrades">Upgrades</a><button aria-label="Expand sidebar category &#x27;Upgrades&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/kubeconfig">Kubeconfig File</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/etcd-snapshots">Backups and Disaster Recovery</a><button aria-label="Collapse sidebar category &#x27;Backups and Disaster Recovery&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/etcd-snapshots/one-time-snapshots">One-time Snapshots</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/etcd-snapshots/recurring-snapshots">Recurring Snapshots</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/etcd-snapshots/restoring-from-backup">Restoring from Backup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/etcd-snapshots/example-scenarios">Example Scenarios</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/etcd-snapshots/troubleshooting">Troubleshooting</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cert-mgmt">Certificate Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/managing-clusters">Adding and Removing Nodes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/config-options">Kubernetes Configuration Options</a><button aria-label="Expand sidebar category &#x27;Kubernetes Configuration Options&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/example-yamls">Example Cluster.ymls</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/troubleshooting">Troubleshooting</a><button aria-label="Expand sidebar category &#x27;Troubleshooting&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/etcd-snapshots"><span itemprop="name">Backups and Disaster Recovery</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Example Scenarios</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Example Scenarios</h1></header><p>These example scenarios for backup and restore are different based on your version of RKE.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">RKE v0.2.0+</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">RKE before v0.2.0</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>This walkthrough will demonstrate how to restore an etcd cluster from a local snapshot with the following steps:</p><ol>
<li><a href="#1-back-up-the-cluster">Back up the cluster</a></li>
<li><a href="#2-simulate-a-node-failure">Simulate a node failure</a></li>
<li><a href="#3-add-a-new-etcd-node-to-the-kubernetes-cluster">Add a new etcd node to the cluster</a></li>
<li><a href="#4-restore-etcd-on-the-new-node-from-the-backup">Restore etcd on the new node from the backup</a></li>
<li><a href="#5-confirm-that-cluster-operations-are-restored">Confirm that cluster operations are restored</a></li>
</ol><p>In this example, the Kubernetes cluster was deployed on two AWS nodes.</p><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">IP</th><th style="text-align:center">Role</th></tr></thead><tbody><tr><td style="text-align:center">node1</td><td style="text-align:center">10.0.0.1</td><td style="text-align:center">[controlplane, worker]</td></tr><tr><td style="text-align:center">node2</td><td style="text-align:center">10.0.0.2</td><td style="text-align:center">[etcd]</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-back-up-the-cluster">1. Back Up the Cluster<a href="#1-back-up-the-cluster" class="hash-link" aria-label="Direct link to 1. Back Up the Cluster" title="Direct link to 1. Back Up the Cluster">​</a></h3><p>Take a local snapshot of the Kubernetes cluster.</p><p>You can upload this snapshot directly to an S3 backend with the <a href="/etcd-snapshots/one-time-snapshots#options-for-rke-etcd-snapshot-save">S3 options</a>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke etcd snapshot-save --name snapshot.db --config cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-simulate-a-node-failure">2. Simulate a Node Failure<a href="#2-simulate-a-node-failure" class="hash-link" aria-label="Direct link to 2. Simulate a Node Failure" title="Direct link to 2. Simulate a Node Failure">​</a></h3><p>To simulate the failure, let&#x27;s power down <code>node2</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node2:~# poweroff</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">IP</th><th style="text-align:center">Role</th></tr></thead><tbody><tr><td style="text-align:center">node1</td><td style="text-align:center">10.0.0.1</td><td style="text-align:center">[controlplane, worker]</td></tr><tr><td style="text-align:center"><del>node2</del></td><td style="text-align:center"><del>10.0.0.2</del></td><td style="text-align:center"><del>[etcd]</del></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-add-a-new-etcd-node-to-the-kubernetes-cluster">3. Add a New etcd Node to the Kubernetes Cluster<a href="#3-add-a-new-etcd-node-to-the-kubernetes-cluster" class="hash-link" aria-label="Direct link to 3. Add a New etcd Node to the Kubernetes Cluster" title="Direct link to 3. Add a New etcd Node to the Kubernetes Cluster">​</a></h3><p>Before updating and restoring etcd, you will need to add the new node into the Kubernetes cluster with the <code>etcd</code> role. In the <code>cluster.yml</code>, comment out the old node and add in the new node.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">nodes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10.0.0.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">hostname_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> controlplane</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#    - address: 10.0.0.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      hostname_override: node2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      user: ubuntu</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      role:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#       - etcd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10.0.0.3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">hostname_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-restore-etcd-on-the-new-node-from-the-backup">4. Restore etcd on the New Node from the Backup<a href="#4-restore-etcd-on-the-new-node-from-the-backup" class="hash-link" aria-label="Direct link to 4. Restore etcd on the New Node from the Backup" title="Direct link to 4. Restore etcd on the New Node from the Backup">​</a></h3><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Prerequisite</div><div class="admonitionContent_BuS1"><p>If the snapshot was created using RKE v1.1.4 or higher, the cluster state file should be included in the snapshot. The cluster state file will be automatically extracted and used for the restore. If the snapshot was created using RKE v1.1.3 or lower, please ensure your <code>cluster.rkestate</code> is present before starting the restore, because this contains your certificate data for the cluster.</p></div></div><p>After the new node is added to the <code>cluster.yml</code>, run the <code>rke etcd snapshot-restore</code> to launch <code>etcd</code> from the backup:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke etcd snapshot-restore --name snapshot.db --config cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The snapshot is expected to be saved at <code>/opt/rke/etcd-snapshots</code>.</p><p>If you want to directly retrieve the snapshot from S3, add in the <a href="/etcd-snapshots/restoring-from-backup#options-for-rke-etcd-snapshot-restore">S3 options</a>.</p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>As of v0.2.0, the file <code>pki.bundle.tar.gz</code> is no longer required for the restore process because the certificates required to restore are preserved within the <code>cluster.rkestate</code>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-confirm-that-cluster-operations-are-restored">5. Confirm that Cluster Operations are Restored<a href="#5-confirm-that-cluster-operations-are-restored" class="hash-link" aria-label="Direct link to 5. Confirm that Cluster Operations are Restored" title="Direct link to 5. Confirm that Cluster Operations are Restored">​</a></h3><p>The <code>rke etcd snapshot-restore</code> command triggers <code>rke up</code> using the new <code>cluster.yml</code>. Confirm that your Kubernetes cluster is functional by checking the pods on your cluster.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; kubectl get pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                     READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-kcdpr   1/1       Running   0          17s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-pc45c   1/1       Running   0          17s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-qkhml   1/1       Running   0          17s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>This walkthrough will demonstrate how to restore an etcd cluster from a local snapshot with the following steps:</p><ol>
<li><a href="#take-a-local-snapshot-of-the-cluster-rke-before-v0.2.0">Take a local snapshot of the cluster</a></li>
<li><a href="#store-the-snapshot-externally-rke-before-v0.2.0">Store the snapshot externally</a></li>
<li><a href="#simulate-a-node-failure-rke-before-v0.2.0">Simulate a node failure</a></li>
<li><a href="#remove-the-kubernetes-cluster-and-clean-the-nodes-rke-before-v0.2.0">Remove the Kubernetes cluster and clean the nodes</a></li>
<li><a href="#retrieve-the-backup-and-place-it-on-a-new-node-rke-before-v0.2.0">Retrieve the backup and place it on a new node</a></li>
<li><a href="#add-a-new-etcd-node-to-the-kubernetes-cluster-rke-before-v0.2.0">Add a new etcd node to the Kubernetes cluster</a></li>
<li><a href="#restore-etcd-on-the-new-node-from-the-backup-rke-before-v0.2.0">Restore etcd on the new node from the backup</a></li>
<li><a href="#restore-operations-on-the-cluster-rke-before-v0.2.0">Restore Operations on the Cluster</a></li>
</ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-scenario-of-restoring-from-a-local-snapshot">Example Scenario of restoring from a Local Snapshot<a href="#example-scenario-of-restoring-from-a-local-snapshot" class="hash-link" aria-label="Direct link to Example Scenario of restoring from a Local Snapshot" title="Direct link to Example Scenario of restoring from a Local Snapshot">​</a></h3><p>In this example, the Kubernetes cluster was deployed on two AWS nodes.</p><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">IP</th><th style="text-align:center">Role</th></tr></thead><tbody><tr><td style="text-align:center">node1</td><td style="text-align:center">10.0.0.1</td><td style="text-align:center">[controlplane, worker]</td></tr><tr><td style="text-align:center">node2</td><td style="text-align:center">10.0.0.2</td><td style="text-align:center">[etcd]</td></tr></tbody></table><a id="take-a-local-snapshot-of-the-cluster-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-take-a-local-snapshot-of-the-cluster">1. Take a Local Snapshot of the Cluster<a href="#1-take-a-local-snapshot-of-the-cluster" class="hash-link" aria-label="Direct link to 1. Take a Local Snapshot of the Cluster" title="Direct link to 1. Take a Local Snapshot of the Cluster">​</a></h3><p>Back up the Kubernetes cluster by taking a local snapshot:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke etcd snapshot-save --name snapshot.db --config cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a id="store-the-snapshot-externally-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-store-the-snapshot-externally">2. Store the Snapshot Externally<a href="#2-store-the-snapshot-externally" class="hash-link" aria-label="Direct link to 2. Store the Snapshot Externally" title="Direct link to 2. Store the Snapshot Externally">​</a></h3><p>After taking the etcd snapshot on <code>node2</code>, we recommend saving this backup in a persistent place. One of the options is to save the backup and <code>pki.bundle.tar.gz</code> file on an S3 bucket or tape backup.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># If you&#x27;re using an AWS host and have the ability to connect to S3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node2:~# s3cmd mb s3://rke-etcd-backup</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node2:~# s3cmd \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  /opt/rke/etcd-snapshots/snapshot.db \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  /opt/rke/etcd-snapshots/pki.bundle.tar.gz \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  s3://rke-etcd-backup/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a id="simulate-a-node-failure-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-simulate-a-node-failure">3. Simulate a Node Failure<a href="#3-simulate-a-node-failure" class="hash-link" aria-label="Direct link to 3. Simulate a Node Failure" title="Direct link to 3. Simulate a Node Failure">​</a></h3><p>To simulate the failure, let&#x27;s power down <code>node2</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node2:~# poweroff</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th style="text-align:center">Name</th><th style="text-align:center">IP</th><th style="text-align:center">Role</th></tr></thead><tbody><tr><td style="text-align:center">node1</td><td style="text-align:center">10.0.0.1</td><td style="text-align:center">[controlplane, worker]</td></tr><tr><td style="text-align:center"><del>node2</del></td><td style="text-align:center"><del>10.0.0.2</del></td><td style="text-align:center"><del>[etcd]</del></td></tr></tbody></table><a id="remove-the-kubernetes-cluster-and-clean-the-nodes-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-remove-the-kubernetes-cluster-and-clean-the-nodes">4. Remove the Kubernetes Cluster and Clean the Nodes<a href="#4-remove-the-kubernetes-cluster-and-clean-the-nodes" class="hash-link" aria-label="Direct link to 4. Remove the Kubernetes Cluster and Clean the Nodes" title="Direct link to 4. Remove the Kubernetes Cluster and Clean the Nodes">​</a></h3><p>The following command removes your cluster and cleans the nodes so that the cluster can be restored without any conflicts:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">rke remove --config rancher-cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a id="retrieve-the-backup-and-place-it-on-a-new-node-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-retrieve-the-backup-and-place-it-on-a-new-node">5. Retrieve the Backup and Place it On a New Node<a href="#5-retrieve-the-backup-and-place-it-on-a-new-node" class="hash-link" aria-label="Direct link to 5. Retrieve the Backup and Place it On a New Node" title="Direct link to 5. Retrieve the Backup and Place it On a New Node">​</a></h3><p>Before restoring etcd and running <code>rke up</code>, we need to retrieve the backup saved on S3 to a new node, e.g. <code>node3</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Make a Directory</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node3:~# mkdir -p /opt/rke/etcdbackup</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Get the Backup from S3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node3:~# s3cmd get \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  s3://rke-etcd-backup/snapshot.db \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  /opt/rke/etcd-snapshots/snapshot.db</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Get the pki bundle from S3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">root@node3:~# s3cmd get \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  s3://rke-etcd-backup/pki.bundle.tar.gz \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  /opt/rke/etcd-snapshots/pki.bundle.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If you had multiple etcd nodes, you would have to manually sync the snapshot and <code>pki.bundle.tar.gz</code> across all of the etcd nodes in the cluster.</p></div></div><a id="add-a-new-etcd-node-to-the-kubernetes-cluster-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-add-a-new-etcd-node-to-the-kubernetes-cluster">6. Add a New etcd Node to the Kubernetes Cluster<a href="#6-add-a-new-etcd-node-to-the-kubernetes-cluster" class="hash-link" aria-label="Direct link to 6. Add a New etcd Node to the Kubernetes Cluster" title="Direct link to 6. Add a New etcd Node to the Kubernetes Cluster">​</a></h3><p>Before updating and restoring etcd, you will need to add the new node into the Kubernetes cluster with the <code>etcd</code> role. In the <code>cluster.yml</code>, comment out the old node and add in the new node. `</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">nodes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10.0.0.1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">hostname_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> controlplane</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#    - address: 10.0.0.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      hostname_override: node2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      user: ubuntu</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#      role:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#       - etcd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 10.0.0.3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">hostname_override</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">role</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a id="restore-etcd-on-the-new-node-from-the-backup-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-restore-etcd-on-the-new-node-from-the-backup">7. Restore etcd on the New Node from the Backup<a href="#7-restore-etcd-on-the-new-node-from-the-backup" class="hash-link" aria-label="Direct link to 7. Restore etcd on the New Node from the Backup" title="Direct link to 7. Restore etcd on the New Node from the Backup">​</a></h3><p>After the new node is added to the <code>cluster.yml</code>, run the <code>rke etcd snapshot-restore</code> command to launch <code>etcd</code> from the backup:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke etcd snapshot-restore --name snapshot.db --config cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The snapshot and <code>pki.bundle.tar.gz</code> file are expected to be saved at <code>/opt/rke/etcd-snapshots</code> on each etcd node.</p><a id="restore-operations-on-the-cluster-rke-before-v0.2.0"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-restore-operations-on-the-cluster">8. Restore Operations on the Cluster<a href="#8-restore-operations-on-the-cluster" class="hash-link" aria-label="Direct link to 8. Restore Operations on the Cluster" title="Direct link to 8. Restore Operations on the Cluster">​</a></h3><p>Finally, we need to restore the operations on the cluster. We will make the Kubernetes API point to the new <code>etcd</code> by running <code>rke up</code> again using the new <code>cluster.yml</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ rke up --config cluster.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Confirm that your Kubernetes cluster is functional by checking the pods on your cluster.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; kubectl get pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                     READY     STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-kcdpr   1/1       Running   0          17s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-pc45c   1/1       Running   0          17s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-65899c769f-qkhml   1/1       Running   0          17s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/rke1-docs/edit/main/docs/etcd-snapshots/example-scenarios/example-scenarios.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-02-26T22:35:50.000Z">Feb 26, 2024</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/etcd-snapshots/restoring-from-backup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Restoring from Backup</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/etcd-snapshots/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Troubleshooting</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-back-up-the-cluster" class="table-of-contents__link toc-highlight">1. Back Up the Cluster</a></li><li><a href="#2-simulate-a-node-failure" class="table-of-contents__link toc-highlight">2. Simulate a Node Failure</a></li><li><a href="#3-add-a-new-etcd-node-to-the-kubernetes-cluster" class="table-of-contents__link toc-highlight">3. Add a New etcd Node to the Kubernetes Cluster</a></li><li><a href="#4-restore-etcd-on-the-new-node-from-the-backup" class="table-of-contents__link toc-highlight">4. Restore etcd on the New Node from the Backup</a></li><li><a href="#5-confirm-that-cluster-operations-are-restored" class="table-of-contents__link toc-highlight">5. Confirm that Cluster Operations are Restored</a></li><li><a href="#example-scenario-of-restoring-from-a-local-snapshot" class="table-of-contents__link toc-highlight">Example Scenario of restoring from a Local Snapshot</a></li><li><a href="#1-take-a-local-snapshot-of-the-cluster" class="table-of-contents__link toc-highlight">1. Take a Local Snapshot of the Cluster</a></li><li><a href="#2-store-the-snapshot-externally" class="table-of-contents__link toc-highlight">2. Store the Snapshot Externally</a></li><li><a href="#3-simulate-a-node-failure" class="table-of-contents__link toc-highlight">3. Simulate a Node Failure</a></li><li><a href="#4-remove-the-kubernetes-cluster-and-clean-the-nodes" class="table-of-contents__link toc-highlight">4. Remove the Kubernetes Cluster and Clean the Nodes</a></li><li><a href="#5-retrieve-the-backup-and-place-it-on-a-new-node" class="table-of-contents__link toc-highlight">5. Retrieve the Backup and Place it On a New Node</a></li><li><a href="#6-add-a-new-etcd-node-to-the-kubernetes-cluster" class="table-of-contents__link toc-highlight">6. Add a New etcd Node to the Kubernetes Cluster</a></li><li><a href="#7-restore-etcd-on-the-new-node-from-the-backup" class="table-of-contents__link toc-highlight">7. Restore etcd on the New Node from the Backup</a></li><li><a href="#8-restore-operations-on-the-cluster" class="table-of-contents__link toc-highlight">8. Restore Operations on the Cluster</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-upgrades/how-upgrades-work/how-upgrades-work">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">How Upgrades Work | RKE1</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://rke.docs.rancher.com/upgrades/how-upgrades-work"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="How Upgrades Work | RKE1"><meta data-rh="true" name="description" content="In this section, you&#x27;ll learn what happens when you edit or upgrade your RKE Kubernetes cluster. The below sections describe how each type of node is upgraded by default when a cluster is upgraded using rke up."><meta data-rh="true" property="og:description" content="In this section, you&#x27;ll learn what happens when you edit or upgrade your RKE Kubernetes cluster. The below sections describe how each type of node is upgraded by default when a cluster is upgraded using rke up."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://rke.docs.rancher.com/upgrades/how-upgrades-work"><link data-rh="true" rel="alternate" href="https://rke.docs.rancher.com/upgrades/how-upgrades-work" hreflang="en"><link data-rh="true" rel="alternate" href="https://rke.docs.rancher.com/upgrades/how-upgrades-work" hreflang="x-default"><link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-57KS2MW",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><link rel="stylesheet" href="/assets/css/styles.76a86532.css">
<link rel="preload" href="/assets/js/runtime~main.6cc0c1ee.js" as="script">
<link rel="preload" href="/assets/js/main.061f9a94.js" as="script">
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-57KS2MW" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-horizontal-rke.svg" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-horizontal-rke.svg" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/rancher/rke1-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Rancher Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Overview of RKE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/os">Requirements</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/installation">RKE Kubernetes Installation</a><button aria-label="Toggle the collapsible sidebar category &#x27;RKE Kubernetes Installation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/upgrades">Upgrades</a><button aria-label="Toggle the collapsible sidebar category &#x27;Upgrades&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/upgrades/how-upgrades-work">How Upgrades Work</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/upgrades/maintaining-availability">Maintaining Availability for Applications During Upgrades</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/upgrades/configuring-strategy">Configuring the Upgrade Strategy</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/kubeconfig">Kubeconfig File</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/etcd-snapshots">Backups and Disaster Recovery</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backups and Disaster Recovery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cert-mgmt">Certificate Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/managing-clusters">Adding and Removing Nodes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/config-options">Kubernetes Configuration Options</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes Configuration Options&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/example-yamls">Example Cluster.ymls</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/troubleshooting">Troubleshooting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Troubleshooting&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/upgrades"><span itemprop="name">Upgrades</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">How Upgrades Work</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How Upgrades Work</h1></header><p>In this section, you&#x27;ll learn what happens when you edit or upgrade your RKE Kubernetes cluster. The below sections describe how each type of node is upgraded by default when a cluster is upgraded using <code>rke up</code>.</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">RKE v1.1.0+</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">RKE before v1.1.0</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>The following features are new in RKE v1.1.0:</p><ul><li>The ability to upgrade or edit a cluster without downtime for your applications.</li><li>The ability to manually upgrade nodes of a certain role without upgrading others.</li><li>The ability to restore a Kubernetes cluster to an older Kubernetes version by restoring it to a snapshot that includes the older Kubernetes version. This capability allows you to safely upgrade one type of node at a time, because if an upgrade cannot be completed by all nodes in the cluster, you can downgrade the Kubernetes version of the nodes that were already upgraded.</li></ul><p>When a cluster is upgraded with <code>rke up</code>, using the default options, the following process is used:</p><ol><li>The etcd plane gets get updated, one node at a time.</li><li>Controlplane nodes get updated, one node at a time. This includes the controlplane components and worker plane components of the controlplane nodes.</li><li>Worker plane components of etcd nodes get updated, one node at a time.</li><li>Worker nodes get updated in batches of a configurable size. The default configuration for the maximum number of unavailable nodes is ten percent, rounded down to the nearest node, with a minimum batch size of one node.</li><li><a href="/config-options/add-ons">Addons</a> get upgraded one by one.</li></ol><p>The following sections break down in more detail what happens when etcd nodes, controlplane nodes, worker nodes, and addons are upgraded. This information is intended to be used to help you understand the update strategy for the cluster, and may be useful when troubleshooting problems with upgrading the cluster.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-etcd-nodes">Upgrades of etcd Nodes<a href="#upgrades-of-etcd-nodes" class="hash-link" aria-label="Direct link to Upgrades of etcd Nodes" title="Direct link to Upgrades of etcd Nodes">​</a></h3><p>A cluster upgrade begins by upgrading the etcd nodes one at a time.</p><p>If an etcd node fails at any time, the upgrade will fail and no more nodes will be upgraded. The cluster will be stuck in an updating state and not move forward to upgrading controlplane or worker nodes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-controlplane-nodes">Upgrades of Controlplane Nodes<a href="#upgrades-of-controlplane-nodes" class="hash-link" aria-label="Direct link to Upgrades of Controlplane Nodes" title="Direct link to Upgrades of Controlplane Nodes">​</a></h3><p>Controlplane nodes are upgraded one at a time by default. The maximum number of unavailable controlplane nodes can also be configured, so that they can be upgraded in batches.</p><p>As long as the maximum unavailable number or percentage of controlplane nodes has not been reached, Rancher will continue to upgrade other controlplane nodes, then the worker nodes.</p><p>If any controlplane nodes were unable to be upgraded, the upgrade will not proceed to the worker nodes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-worker-nodes">Upgrades of Worker Nodes<a href="#upgrades-of-worker-nodes" class="hash-link" aria-label="Direct link to Upgrades of Worker Nodes" title="Direct link to Upgrades of Worker Nodes">​</a></h3><p>By default, worker nodes are upgraded in batches. The size of the batch is determined by the maximum number of unavailable worker nodes, configured as the <code>max_unavailable_worker</code> directive in the <code>cluster.yml</code>.</p><p>By default, the <code>max_unavailable_worker</code> nodes is defined as 10 percent of all worker nodes. This number can be configured as a percentage or as an integer. When defined as a percentage, the batch size is rounded down to the nearest node, with a minimum of one node.</p><p>For example, if you have 11 worker nodes and <code>max_unavailable_worker</code> is 25%, two nodes will be upgraded at once because 25% of 11 is 2.75. If you have two worker nodes and <code>max_unavailable_worker</code> is 1%, the worker nodes will be upgraded one at a time because the minimum batch size is one.</p><p>When each node in a batch returns to a Ready state, the next batch of nodes begins to upgrade. If <code>kubelet</code> and <code>kube-proxy</code> have started, the node is Ready. As long as the <code>max_unavailable_worker</code> number of nodes have not failed, Rancher will continue to upgrade other worker nodes.</p><p>RKE scans the cluster before starting the upgrade to find the powered down or unreachable hosts. The upgrade will stop if that number matches or exceeds the maximum number of unavailable nodes.</p><p>RKE will cordon each node before upgrading it, and uncordon the node afterward. RKE can also be configured to <a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noopener noreferrer">drain</a> nodes before upgrading them.</p><p>RKE will handle all worker node upgrades before upgrading any add-ons. As long as the maximum number of unavailable worker nodes is not reached, RKE will attempt to upgrade the <a href="#upgrades-of-addons">addons.</a> For example, if a cluster has two worker nodes and one worker node fails, but the maximum unavailable worker nodes is greater than one, the addons will still be upgraded.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-addons">Upgrades of Addons<a href="#upgrades-of-addons" class="hash-link" aria-label="Direct link to Upgrades of Addons" title="Direct link to Upgrades of Addons">​</a></h3><p>The availability of your applications partly depends on the availability of <a href="/config-options/add-ons">RKE addons.</a> Addons are used to deploy several cluster components, including network plug-ins, the Ingress controller, DNS provider, and metrics server.</p><p>Because RKE addons are necessary for allowing traffic into the cluster, they will need to be updated in batches to maintain availability. You will need to configure the maximum number of unavailable replicas for each addon in the <code>cluster.yml</code> to ensure that your cluster will retain enough available replicas during an upgrade.</p><p>For more information on configuring the number of replicas for each addon, refer to <a href="/upgrades/configuring-strategy">this section.</a></p><p>For an example showing how to configure the addons, refer to the <a href="/example-yamls">example cluster.yml.</a></p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>When a cluster is upgraded with <code>rke up</code>, using the default options, the following process is used:</p><ul><li>etcd nodes get updated first, one at a time.</li><li>Controlplane nodes get updated second, in batches of 50 or the total number of worker nodes, whichever is lower.</li><li>Worker nodes and addons get updated third, in batches of 50 or the total number of worker nodes, whichever is lower.</li><li>Addons get upgraded one by one.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-controlplane-and-etcd-nodes">Upgrades of Controlplane and etcd Nodes<a href="#upgrades-of-controlplane-and-etcd-nodes" class="hash-link" aria-label="Direct link to Upgrades of Controlplane and etcd Nodes" title="Direct link to Upgrades of Controlplane and etcd Nodes">​</a></h3><p>Controlplane and etcd nodes would be upgraded in batches of 50 nodes or the total number of controlplane nodes, whichever is lower.</p><p>If a node fails at any time, the upgrade will stop upgrading any other nodes and fail.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrades-of-worker-nodes-1">Upgrades of Worker Nodes<a href="#upgrades-of-worker-nodes-1" class="hash-link" aria-label="Direct link to Upgrades of Worker Nodes" title="Direct link to Upgrades of Worker Nodes">​</a></h3><p>Worker nodes are upgraded simultaneously, in batches of either 50 or the total number of worker nodes, whichever is lower. If a worker node fails at any time, the upgrade stops.</p><p>When a worker node is upgraded, it restarts several Docker processes, including the <code>kubelet</code> and <code>kube-proxy</code>. When <code>kube-proxy</code> comes up, it flushes <code>iptables</code>. When this happens, pods on this node can’t be accessed, resulting in downtime for the applications.</p></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rancher/rke1-docs/edit/main/docs/upgrades/how-upgrades-work/how-upgrades-work.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-09-19T23:36:12.000Z">Sep 19, 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/upgrades"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Upgrades</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/upgrades/maintaining-availability"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Maintaining Availability for Applications During Upgrades</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#upgrades-of-etcd-nodes" class="table-of-contents__link toc-highlight">Upgrades of etcd Nodes</a></li><li><a href="#upgrades-of-controlplane-nodes" class="table-of-contents__link toc-highlight">Upgrades of Controlplane Nodes</a></li><li><a href="#upgrades-of-worker-nodes" class="table-of-contents__link toc-highlight">Upgrades of Worker Nodes</a></li><li><a href="#upgrades-of-addons" class="table-of-contents__link toc-highlight">Upgrades of Addons</a></li><li><a href="#upgrades-of-controlplane-and-etcd-nodes" class="table-of-contents__link toc-highlight">Upgrades of Controlplane and etcd Nodes</a></li><li><a href="#upgrades-of-worker-nodes-1" class="table-of-contents__link toc-highlight">Upgrades of Worker Nodes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6cc0c1ee.js"></script>
<script src="/assets/js/main.061f9a94.js"></script>
</body>
</html>